"use strict";function _extends(){return _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},_extends.apply(this,arguments)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function FieldInputs(e){return e.nested?React.createElement("ul",{className:"field-inputs field-nested"},e.children):React.createElement("div",{className:"field-inputs"},e.children)}/*!
 * This source file is part of the open source project
 * ExpressionEngine (https://expressionengine.com)
 *
 * @link      https://expressionengine.com/
 * @copyright Copyright (c) 2003-2019, EllisLab Corp. (https://ellislab.com)
 * @license   https://expressionengine.com/license Licensed under Apache License, Version 2.0
 */
var SelectList=function(e){function t(e){var n;return _classCallCheck(this,t),n=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e)),_defineProperty(_assertThisInitialized(_assertThisInitialized(n)),"handleSelect",function(e,t){var r=[],l=e.target.checked,a="--";if(n.props.multi&&t.value!=a)if(l)r=n.props.selected.concat([t]).filter(function(e){return e.value!=a}),n.props.selectionShouldRetainItemOrder&&(r=n.getOrderedSelection(r)),t.parent&&n.props.autoSelectParents&&(r=r.concat(n.diffItems(n.props.selected,n.getFlattenedParentsOfItem(t))));else{var i=[t];t.children&&n.props.autoSelectParents&&(i=i.concat(n.getFlattenedChildrenOfItem(t))),r=n.diffItems(i,n.props.selected)}else r=l?[t]:[];n.props.selectionChanged(r),n.props.groupToggle&&EE.cp.form_group_toggle(e.target)}),_defineProperty(_assertThisInitialized(_assertThisInitialized(n)),"clearSelection",function(e){n.props.selectionChanged([]),e.preventDefault()}),_defineProperty(_assertThisInitialized(_assertThisInitialized(n)),"filterChange",function(e,t){n.props.filterChange(e,t)}),_defineProperty(_assertThisInitialized(_assertThisInitialized(n)),"handleToggleAll",function(e){e?(newlySelected=n.props.items.filter(function(e){return(!n.props.disabledChoices||!n.props.disabledChoices.includes(e.value))&&(found=n.props.selected.find(function(t){return t.value==e.value}),!found)}),n.props.selectionChanged(n.props.selected.concat(newlySelected))):n.props.disabledChoices?n.props.selectionChanged(n.props.selected.filter(function(e){return n.props.disabledChoices.includes(e.value)})):n.props.selectionChanged([])}),n.version=0,n}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){this.props.nestableReorder?this.bindNestable():this.props.reorderable&&this.bindSortable()}},{key:"componentDidUpdate",value:function(e,t){(this.props.multi&&e.selected.length!=this.props.selected.length||!this.props.multi&&e.selected!=this.props.selected)&&$(this.input).trigger("change"),this.props.nestableReorder&&this.bindNestable()}},{key:"bindSortable",value:function(){var e=this,t=this.props.nested?".field-nested":".field-inputs";$(t,this.container).sortable({axis:"y",containment:"parent",handle:".icon-reorder",items:this.props.nested?"> li":"label",placeholder:"field-reorder-placeholder",sort:EE.sortable_sort_helper,start:function(e,t){t.helper.addClass("field-reorder-drag")},stop:function(t,n){n.item.removeClass("field-reorder-drag").addClass("field-reorder-drop"),setTimeout(function(){n.item.removeClass("field-reorder-drop")},1e3);var r=function o(e){var t=[];return e.forEach(function(e){var n={id:e.dataset.id},r=$(e).find("> ul > [data-id]");r.size()&&(n.children=o(r.toArray())),t.push(n)}),t},l=n.item.closest(".field-inputs").find("> [data-id]").toArray(),a=e.getItemsHash(e.props.items),i=r(l);e.props.itemsChanged(e.getItemsArrayForNestable(a,i)),e.props.reorderAjaxUrl&&$.ajax({url:e.props.reorderAjaxUrl,data:{order:i},type:"POST",dataType:"json"})}})}},{key:"bindNestable",value:function(){var e=this;$(this.container).nestable({listNodeName:"ul",listClass:"field-nested",itemClass:"nestable-item",rootClass:"field-select",dragClass:"field-inputs.field-reorder-drag",handleClass:"icon-reorder",placeElement:$('<li class="field-reorder-placeholder"></li>'),expandBtnHTML:"",collapseBtnHTML:"",maxDepth:10,constrainToRoot:!0}).on("change",function(t){if($(t.target).data("nestable")){e.version++;var n=e.getItemsHash(e.props.items),r=$(t.target).nestable("serialize");e.props.itemsChanged(e.getItemsArrayForNestable(n,r)),e.props.reorderAjaxUrl&&$.ajax({url:e.props.reorderAjaxUrl,data:{order:r},type:"POST",dataType:"json"})}})}},{key:"getItemsHash",value:function(e){var t=this,n={};return e.forEach(function(e){n[e.value]=e,e.children&&(n=Object.assign(n,t.getItemsHash(e.children)))}),n}},{key:"getItemsArrayForNestable",value:function(e,t,n){var r=this,l=[];return t.forEach(function(t){var a=e[t.id],i=Object.assign({},a);i.parent=n?n:null,i.children=t.children?r.getItemsArrayForNestable(e,t.children,i):null,l.push(i)}),l}},{key:"getOrderedSelection",value:function(e){var t=this;return orderedSelection=[],e.sort(function(e,n){return e=t.props.initialItems.findIndex(function(t){return t.value==e.value}),n=t.props.initialItems.findIndex(function(e){return e.value==n.value}),e<n?-1:1})}},{key:"diffItems",value:function(e,t){var n=e.map(function(e){return e.value});return t.filter(function(e){return n.every(function(t){return t!=e.value})})}},{key:"getFlattenedParentsOfItem",value:function(e){for(var t=[];e.parent;)t.push(e.parent),e=e.parent;return t}},{key:"getFlattenedChildrenOfItem",value:function(e){var t=this,n=[];return e.children.forEach(function(e){n.push(e),e.children&&(n=n.concat(t.getFlattenedChildrenOfItem(e)))}),n}},{key:"getFullItem",value:function(e){var t=this.getItemsHash(this.props.initialItems);return void 0!==t[e.value]?t[e.value]:e}},{key:"render",value:function(){var e=this,n=this.props,r=(n.multi||!n.selectable)&&null!==n.toggleAll;return React.createElement("div",{className:"fields-select"+(t.countItems(n.items)>n.tooManyLimit?" field-resizable":""),ref:function(t){e.container=t},key:this.version},(r||n.tooMany)&&React.createElement(FieldTools,null,n.tooMany&&React.createElement(FilterBar,null,n.filters&&n.filters.map(function(t){return React.createElement(FilterSelect,{key:t.name,name:t.name,keepSelectedState:!0,title:t.title,placeholder:t.placeholder,items:t.items,onSelect:function(n){return e.filterChange(t.name,n)}})}),React.createElement(FilterSearch,{onSearch:function(t){return e.filterChange("search",t.target.value)}})),r&&n.tooMany&&React.createElement("hr",null),r&&React.createElement(FilterToggleAll,{checkAll:n.toggleAll,onToggleAll:function(t){return e.handleToggleAll(t)}})),React.createElement(FieldInputs,{nested:n.nested},!n.loading&&0==n.items.length&&React.createElement(NoResults,{text:n.noResults}),n.loading&&React.createElement(Loading,{text:EE.lang.loading}),!n.loading&&n.items.map(function(t,r){return React.createElement(SelectItem,{key:t.value?t.value:t.section,item:t,name:n.name,selected:n.selected,disabledChoices:n.disabledChoices,multi:n.multi,nested:n.nested,selectable:n.selectable,reorderable:n.reorderable,removable:n.removable&&(!n.unremovableChoices||!n.unremovableChoices.includes(t.value)),editable:n.editable,handleSelect:e.handleSelect,handleRemove:function(e,t){return n.handleRemove(e,t)},groupToggle:n.groupToggle})})),!n.multi&&n.tooMany&&n.selected[0]&&React.createElement(SelectedItem,{item:this.getFullItem(n.selected[0]),clearSelection:this.clearSelection,selectionRemovable:n.selectionRemovable}),n.selectable&&0==n.selected.length&&React.createElement("input",{type:"hidden",name:n.multi?n.name+"[]":n.name,value:"",ref:function(t){e.input=t}}),n.selectable&&n.selected.map(function(t){return React.createElement("input",{type:"hidden",key:t.value,name:n.multi?n.name+"[]":n.name,value:t.value,ref:function(t){e.input=t}})}))}}],[{key:"formatItems",value:function(e,n,r){if(!e)return[];for(var l=[],a=null,i=Object.keys(e),o=0;o<i.length;o++)if(key=i[o],e[key].section)a=e[key].section,l.push({section:a,label:""});else{var s=r?e[key]:key,c={value:e[key].value||""===e[key].value?e[key].value:s,label:void 0!==e[key].label?e[key].label:e[key],instructions:e[key].instructions?e[key].instructions:"",children:null,parent:n?n:null,component:void 0!=e[key].component?e[key].component:null,sectionLabel:a};e[key].children&&(c.children=t.formatItems(e[key].children,c)),l.push(c)}return l}},{key:"countItems",value:function(e){return e.length+e.reduce(function(e,n){return n.children?e+t.countItems(n.children):e},0)}}]),t}(React.Component);_defineProperty(SelectList,"defaultProps",{reorderable:!1,nestableReorder:!1,removable:!1,selectable:!0,tooManyLimit:8,toggleAllLimit:3,selectionRemovable:!1,selectionShouldRetainItemOrder:!0});var SelectItem=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"checked",value:function(e){return this.props.selected.find(function(t){return t.value==e})}},{key:"render",value:function(){var e=this.props,n=this.checked(e.item.value),r=e.item.label,l=e.disabledChoices&&e.disabledChoices.includes(e.item.value);if(e.item.section)return React.createElement("div",{className:"field-group-head",key:e.item.section},e.item.section);if(e.item.component){var a="".concat(e.item.component.tag);r=React.createElement(a,{className:e.item.component["class"],style:e.item.component.style},e.item.component.label)}var i=React.createElement("label",{className:n?"act":"","data-id":e.reorderable&&!e.nested?e.item.value:null},e.reorderable&&React.createElement("span",{className:"icon-reorder"}," "),e.selectable&&React.createElement("input",{type:e.multi?"checkbox":"radio",value:e.item.value,onChange:function(t){return e.handleSelect(t,e.item)},checked:n?"checked":"","data-group-toggle":e.groupToggle?JSON.stringify(e.groupToggle):"[]",disabled:l?"disabled":""}),e.editable&&React.createElement("a",{href:"#"},r),!e.editable&&r," ",e.item.instructions&&React.createElement("i",null,e.item.instructions),e.removable&&React.createElement("ul",{className:"toolbar"},React.createElement("li",{className:"remove"},React.createElement("a",{href:"",onClick:function(t){return e.handleRemove(t,e.item)}}))));return e.nested?React.createElement("li",{className:"nestable-item","data-id":e.item.value},i,e.item.children&&React.createElement("ul",{className:"field-nested"},e.item.children.map(function(n,r){return React.createElement(t,_extends({},e,{key:n.value,item:n,handleRemove:function(t,n){return e.handleRemove(t,n)}}))}))):i}}]),t}(React.Component),SelectedItem=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this.props,t=e.item.label;if(e.item.component){var n="".concat(e.item.component.tag);t=React.createElement(n,{className:e.item.component["class"],style:e.item.component.style},e.item.component.label)}return React.createElement("div",{className:"field-input-selected"},React.createElement("label",null,React.createElement("span",{className:"icon--success"})," ",t,e.selectionRemovable&&React.createElement("ul",{className:"toolbar"},React.createElement("li",{className:"remove"},React.createElement("a",{href:"",onClick:e.clearSelection})))))}}]),t}(React.Component);