!function(t){var e=window.Grid={_eventHandlers:[],bind:function(t,e,i){void 0==this._eventHandlers[e]&&(this._eventHandlers[e]=[]),this._eventHandlers[e][t]=i}};e.Publish=function(e,i){null!==e&&void 0!==e&&(this.root=t(e),this.parentContainer=this.root.parents(".grid-publish"),this.blankRow=t("tr.grid-blank-row",this.root),this.emptyField=t("tr.no-results",this.root),this.tableActions=t("tr.tbl-action",this.root),this.rowContainer=this.root.children("tbody"),this.addButtonToolbar=t("ul.toolbar:has(li.add)",this.parentContainer),this.header=null,this.rowSelector="tr",this.cellSelector="td",this.reorderHandleContainerSelector="th.reorder-col, td.reorder-col",this.deleteContainerHeaderSelector="th.grid-remove",this.deleteButtonsSelector="td:last-child .toolbar .remove",this.sortableParams={},this.settings=void 0!==i?i:EE.grid_field_settings[e.id],this.init(),this.eventHandlers=[])},e.MiniField=function(e,i){this.root=t(e),this.root.data("gridInitialized",!0),this.parentContainer=this.root,this.blankRow=t(".grid-blank-row",this.root),this.emptyField=t(".keyvalue-empty",this.root),this.tableActions=null,this.rowContainer=t(".keyvalue-item-container",this.root),this.addButtonToolbar=t("> ul.toolbar",this.parentContainer),this.header=t(".keyvalue-header",this.root),this.rowSelector=".keyvalue-item",this.cellSelector=".keyvalue-field",this.reorderHandleContainerSelector="ul.toolbar:has(li.reorder)",this.deleteContainerHeaderSelector=null,this.deleteButtonsSelector="ul.toolbar:has(li.remove)",this.sortableParams={sortableContainer:".keyvalue-item-container",handle:"li.reorder",cancel:"li.sort-cancel",item:".keyvalue-item"},this.settings=i,this.init(),this._addNewRowOnEnter(),this.eventHandlers=[]},t.fn.miniGrid=function(i){return this.each(function(){return t(this).data("gridInitialized")?void 0:new e.MiniField(this,i)})},e.Publish.prototype=e.MiniField.prototype={init:function(){this._bindSortable(),this._bindAddButton(),this._bindDeleteButton(),this._toggleRowManipulationButtons(),this._fieldDisplay(),this.original_row_count=this._getRows().size(),this.blankRow.find(":input").attr("disabled","disabled")},_addNewRowOnEnter:function(){var e=this;t(this.root).on("keypress","input[type=text]",function(i){13==i.keyCode&&(i.preventDefault(),e._addRow(),t(e.rowSelector,e.root).last().find("input[type=text]").first().focus())})},_bindSortable:function(){var e=this,i={beforeSort:function(t){e._fireEvent("beforeSort",t)},afterSort:function(t){e._fireEvent("afterSort",t)}};i=t.extend(i,this.sortableParams),this.root.eeTableReorder(i)},_addMinimumRows:function(){var t=this._getRows().size(),e=this.settings.grid_min_rows-t;for(0==t&&0==e&&this.emptyField.removeClass("hidden");e>0;)this._addRow(),e--},_toggleRowManipulationButtons:function(){var e=this._getRows().size(),i=(this.root.find("th.reorder-col"),this.root.find("th.grid-remove"),e>0);this.addButtonToolbar.toggle(i),t(this.reorderHandleContainerSelector,this.root).toggle(i),t(this.deleteContainerHeaderSelector,this.root).toggle(i),this.header&&this.header.toggle(i),""!==this.settings.grid_max_rows&&this.addButtonToolbar.toggle(e<this.settings.grid_max_rows&&e>0),""!==this.settings.grid_min_rows&&t(this.deleteButtonsSelector,this.root).toggle(e>this.settings.grid_min_rows),t(this.reorderHandleContainerSelector,this.rowContainer).toggleClass("sort-cancel",1==e)},_getRows:function(){return this.rowContainer.children(this.rowSelector).not(this.blankRow.add(this.emptyField).add(this.tableActions))},_bindAddButton:function(){var e=this;t("a[rel=add_row]",this.parentContainer).add(".tbl-action a.add",this.root).on("click",function(t){t.preventDefault(),e._addRow()})},_addRow:function(){el=this.blankRow.clone(),el.removeClass("grid-blank-row"),el.removeClass("hidden"),this.original_row_count++,el.html(el.html().replace(RegExp("new_row_[0-9]{1,}","g"),"new_row_"+this.original_row_count)),t("> "+this.cellSelector,el).attr("data-new-row-id","new_row_"+this.original_row_count),el.find(":input").removeAttr("disabled"),this.tableActions&&this.tableActions.length?this.tableActions.before(el):this.rowContainer.append(el),this.emptyField.addClass("hidden"),this._toggleRowManipulationButtons(),this._fireEvent("display",el),t(this.root).trigger("grid:addRow",el),EE.cp&&void 0!==EE.cp.formValidation&&EE.cp.formValidation.bindInputs(el)},_bindDeleteButton:function(){var e=this;this.root.on("click","a[rel=remove_row]",function(i){i.preventDefault(),row=t(this).parents(e.rowSelector),e._fireEvent("remove",row),row.remove(),e._toggleRowManipulationButtons(),0==e._getRows().size()&&e.emptyField.removeClass("hidden"),0==t("td.invalid",e.root).size()&&EE.cp&&void 0!==EE.cp.formValidation&&EE.cp.formValidation.markFieldValid(t("input, select, textarea",e.blankRow).eq(0))})},_fieldDisplay:function(){var e=this;setTimeout(function(){e._getRows().each(function(){e._fireEvent("display",t(this))}),e._addMinimumRows()},500)},_fireEvent:function(i,n){if(void 0!==e._eventHandlers[i])for(var o in e._eventHandlers[i])n.find('td[data-fieldtype="'+o+'"]').each(function(){e._eventHandlers[i][o](t(this))})}},e.Settings=function(e){this.root=t(".grid-wrap"),this.settingsScroller=this.root.find(".grid-clip"),this.settingsContainer=this.root.find(".grid-clip-inner"),this.colTemplateContainer=t("#grid_col_settings_elements"),this.blankColumn=this.colTemplateContainer.find(".grid-item"),this.settings=e,this.init()},e.Settings.prototype={init:function(){this._bindResize(),this._bindSortable(),this._bindActionButtons(this.root),this._toggleDeleteButtons(),this._bindColTypeChange(),this._bindValidationCallback(),this._bindAutoColName(this.root.find('div.grid-item[data-field-name^="new_"]')),this._settingsDisplay(),this.colTemplateContainer.find(":input").attr("disabled","disabled")},_bindValidationCallback:function(){EE.cp.formValidation.bindCallbackForField("grid",function(e,i,n){var o=t("div.grid-wrap").prev(),r=n.attr("name"),s="["+n.parents(".grid-item").attr("data-field-name")+"]";r.indexOf("[")>-1&&(r=r.substr(-(r.length-r.lastIndexOf("["))));var a,l=t("<div/>").html(i).contents().html();a=void 0!==i?t('span[data-field="'+r+'"]:contains("'+l+'")',o):t('span[data-field="'+r+'"][data-columns*="'+s+'"]',o);var d=a.attr("data-columns");if(e===!1){n.parents("fieldset").find("em.ee-form-error-message").remove();var h=t("<span/>").attr({"data-field":r,"data-columns":s,style:"display: block"}).text(l);if(o.hasClass("alert"))0==a.size()?t("p",o).append(h):-1==d.indexOf(s)&&a.attr("data-columns",d+s);else{var o=t("<div/>").html(EE.alert.grid_error).contents();o.html("<p>"+h.prop("outerHTML")+"</p>"),o.insertBefore(t("div.grid-wrap"))}}else o.hasClass("alert")&&(a.size()>0&&(a.attr("data-columns",d.replace(s,"")),""==a.attr("data-columns")&&a.remove()),0==t("span",o).size()&&o.remove())})},_bindResize:function(){var e=this;t(document).ready(function(){e._resizeColContainer()})},_resizeColContainer:function(t){this.settingsContainer.animate({width:this._getColumnsWidth()},1==t?400:0)},_getColumnsWidth:function(){var t=this.root.find(".grid-item");return t.size()*(t.width()+32)},_bindSortable:function(){this.settingsContainer.sortable({axis:"x",containment:"parent",handle:"li.reorder",items:".grid-item",sort:EE.sortable_sort_helper}),this.settingsContainer.find("li.reorder a").on("click",function(t){t.preventDefault()})},_bindActionButtons:function(t){this._bindAddButton(t),this._bindCopyButton(t),this._bindDeleteButton(t)},_bindAddButton:function(e){var i=this;e.find(".grid-tools li.add a").on("click",function(e){e.preventDefault();var n=t(this).parents(".grid-item");i._insertColumn(i._buildNewColumn(),n)})},_bindCopyButton:function(e){var i=this;e.find(".grid-tools li.copy a").off("click").on("click",function(e){e.preventDefault();var n=t(this).parents(".grid-item");i._insertColumn(i._buildNewColumn(n),n)})},_bindDeleteButton:function(e){var i=this;e.on("click",".grid-tools li.remove a",function(e){e.preventDefault();var n=t(this).parents(".grid-item");n.index()==t(".grid-item:last",i.root).index()?(n.remove(),i._resizeColContainer(!0),i._toggleDeleteButtons()):n.animate({opacity:0},200,function(){n.html(""),n.animate({width:0},200,function(){n.remove(),i._resizeColContainer(!0),i._toggleDeleteButtons()})}),t("fieldset.invalid input",i.root).trigger("change")})},_toggleDeleteButtons:function(){var t=this.root.find(".grid-item").size()>1,e=this.root.find(".grid-tools li.remove"),i=this.root.find(".grid-tools li.add");e.toggle(t),i.toggleClass("last",!t)},_insertColumn:function(e,i){var n=t(".grid-item:last",this.root);void 0==i&&(i=n),i.index()!=n.index()&&e.css({opacity:0}),e.insertAfter(i),this._resizeColContainer(),this._toggleDeleteButtons(),i.index()==n.index()&&this.settingsScroller.animate({scrollLeft:this._getColumnsWidth()},700),e.animate({opacity:1},400),this._bindAutoColName(e),this._bindActionButtons(e),EE.cp.formValidation.bindInputs(e),this._fireEvent("displaySettings",t(".grid-col-settings-custom > div",e))},_bindAutoColName:function(e){e.each(function(e,i){t("input.grid_col_field_label",i).bind("keyup keydown",function(){t(this).ee_url_title(t(i).find("input.grid_col_field_name"),!0)})})},_buildNewColumn:function(e){e=void 0==e?this.blankColumn.clone():this._cloneWithFormValues(e),e.find('input[name$="\\[col_name\\]"]').attr("value","");var i="new_"+t(".grid-item",this.root).size(),n=e.data("field-name");return e.html(e.html().replace(RegExp('name="grid\\[cols\\]\\['+n+"\\]","g"),'name="grid[cols]['+i+"]")),e.attr("data-field-name",i),e.find(":input").removeAttr("disabled").removeClass("grid_settings_error"),e},_bindColTypeChange:function(){var e=this;this.root.on("change","select.grid_col_select",function(i){var n=e.colTemplateContainer.find(".grid_col_settings_custom_field_"+t(this).val()+":last").clone();n.find(":input").removeAttr("disabled");var o=t(this).parents(".grid-item").find(".grid-col-settings-custom"),r=o.parents(".grid-item").attr("data-field-name"),s="(new_)?[0-9]{1,}";n.html(n.html().replace(RegExp('name="grid\\[cols\\]\\['+s+"\\]","g"),'name="grid[cols]['+r+"]")),o.html(n),e._fireEvent("displaySettings",n)})},_cloneWithFormValues:function(e){var i=e.clone();return e.find(":input:enabled").each(function(){var e=i.find(":input[name='"+t(this).attr("name")+"']:enabled");t(this).is("select")?e.find("option").removeAttr("selected").filter('[value="'+t(this).val()+'"]').attr("selected","selected"):"checkbox"==t(this).attr("type")?t(this).prop("checked")&&e.attr("checked","checked"):"radio"==t(this).attr("type")?e.removeAttr("selected").filter("[value='"+t(this).val()+"']").attr("checked",t(this).attr("checked")):t(this).is("textarea")?e.html(t(this).val()):e.attr("value",t(this).val())}),i},_settingsDisplay:function(){var e=this;this.root.find(".grid-item").each(function(){e._fireEvent("displaySettings",t(".grid-col-settings-custom > div",this))})},_fireEvent:function(i,n){var o=n.data("fieldtype");void 0!==e._eventHandlers[i]&&void 0!=e._eventHandlers[i][o]&&e._eventHandlers[i][o](t(n))}},EE.grid=function(t,i){return new e.Publish(t,i)},EE.grid_settings=function(t){return new e.Settings(t)},"undefined"!=typeof _&&"undefined"!==EE.grid_cache&&_.each(EE.grid_cache,function(t){e.bind.apply(e,t)})}(jQuery);