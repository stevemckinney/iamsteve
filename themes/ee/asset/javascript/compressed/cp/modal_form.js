/*!
 * This source file is part of the open source project
 * ExpressionEngine (https://expressionengine.com)
 *
 * @link      https://expressionengine.com/
 * @copyright Copyright (c) 2003-2019, EllisLab Corp. (https://ellislab.com)
 * @license   https://expressionengine.com/license Licensed under Apache License, Version 2.0
 */
EE.cp.ModalForm={saveAndNew:!1,openForm:function(n){this.modal=$('div[rel="modal-form"]'),this.modalContents=$(".app-modal__content",this.modal),this.modalContentsContainer=$("div.contents",this.modal),this.modalCloseContainer=$(".app-modal__dismiss",this.modal),this.loadingBanner=$(".app-notice---loading",this.modal),this.titleBanner=$(".app-notice---attention",this.modal);var o=n.iframe||!1,t=n.full||!1;this.modal.toggleClass("app-modal--side",!t).toggleClass("app-modal--fullscreen",o||t).find("iframe").remove(),this.modalContents.toggle(!o),this.loadingBanner.toggle(o),this.titleBanner.hide(),this.modal.trigger("modal:open"),this._loadModalContents(n),this._bindSaveAndNew()},_loadModalContents:function(n){if(!n.iframe){var o=$("<span />",{"class":"btn work"}).html("Loading");this.modalContentsContainer.html(o)}var t=this;if(n.iframe){var e=$("<iframe />",{src:n.url+"&modal_form=y","class":"app-modal__frame"}).on("load",function(){t.loadingBanner.hide(),t._bindIframeForm(this,n),n.load(t.modal)});this.modal.append(e)}else this.modalContentsContainer.load(n.url,function(){t._bindForm(n),n.load(t.modalContentsContainer)})},setTitle:function(n){this.titleBanner.show().find(".app-notice__content p").html(n)},_bindSaveAndNew:function(n){var o=this;this.modal.on("click",'button[value="save_and_new"]',function(){o.saveAndNew=!0})},_bindForm:function(n){var o=this;EE.cp.formValidation.init(this.modalContentsContainer.find("form")),$("form",this.modal).on("submit",function(){return $.post(this.action,$(this).serialize(),function(t){return"string"===$.type(t)?(o.modalContentsContainer.html(t),o._bindForm(n),void n.load(o.modalContentsContainer)):(n.success(t),o.saveAndNew?(n.createUrl&&(n.url=n.createUrl),o._loadModalContents(n)):o.modal.trigger("modal:close"),void(o.saveAndNew=!1))}),!1})},_bindIframeForm:function(n,o){$(n).contents().find("[data-publish] > form").on("submit",function(){var e=$(this).serialize()+"&modal_form=y";return $.post(this.action,e,function(e){return"string"===$.type(e)?(n.contentDocument.open(),n.contentDocument.write(e),n.contentDocument.close(),void o.load(t.modalContents)):e.redirect?void(n.src=e.redirect):void(o.success&&o.success(e,t.modal))}),!1});var t=this;$(n).contents().find("body").on("click",".js-modal-close",function(n){t.modal.trigger("modal:close"),n.preventDefault()}),$(n).contents().find("body").on("keydown",function(n){27===n.keyCode&&t.modal.trigger("modal:close")})}};